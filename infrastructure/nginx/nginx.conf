# Define los grupos de servidores para cada microservicio
upstream auth_service {
    server auth-service:3001;
}

upstream users_service {
    server users-service:3002;
}

upstream media_service {
    server media-service:3003;
}

server {
    listen 80;
    server_name localhost;

    # ¡Crucial! Usa el DNS interno de Docker para resolver los nombres de los servicios
    resolver 127.0.0.11;

    # Ruta para el servicio de autenticación
    location /api/auth {
        # Reescribe la URL para quitar el prefijo antes de pasarla al servicio
        rewrite /api/auth/(.*) /$1 break;
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ruta para el servicio de usuarios
    location /api/users {
        rewrite /api/users/(.*) /$1 break;
        proxy_pass http://users_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ruta para el servicio de media
    location /api/media {
        rewrite /api/media/(.*) /$1 break;
        proxy_pass http://media_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}